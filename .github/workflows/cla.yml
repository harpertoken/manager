# SPDX-License-Identifier: MIT
---
name: CLA Assistant

on:
  issue_comment:
    types: [created]
  pull_request_target:
    types: [opened, closed, synchronize]

jobs:
  classistant:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      pull-requests: write
      issues: write
      statuses: write
      checks: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Post CLA instructions on new PR
        if: github.event_name == 'pull_request_target' && github.event.action == 'opened'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: ".github/cla/comment-template.md"

      - name: Run CLA Assistant
        if: >
          github.event_name == 'pull_request_target' ||
          contains(github.event.comment.body, 'recheck') ||
          contains(github.event.comment.body, 'I have read the CLA Document and I hereby sign the CLA')
        uses: contributor-assistant/github-action@v2.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          path-to-document: "CLA.md"
          remote-repository-name: bniladridas/manager
          branch: cla-signatures
          path-to-signatures: "signatures/cla.json"
          use-dco-flag: false
          allowlist: ""
          lock-pullrequest-aftermerge: true

      - name: Split signatures into per-user files
        run: |
          mkdir -p signatures/users

          jq -r 'keys[]' signatures/cla.json | while read user; do
            jq ".\"$user\"" signatures/cla.json > signatures/users/"$user".json
          done

      - name: Commit signature updates
        run: |
          if [ -n "$(git status --porcelain signatures)" ]; then
            git config user.name "cla-bot"
            git config user.email "cla-bot@users.noreply.github.com"
            git add signatures
            git commit -m "chore(cla): update CLA signatures [skip ci]"
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          else
            echo "No signature updates."
          fi

      - name: Regenerate SIGNERS.md
        run: |
          echo "# Contributors Who Signed the CLA" > SIGNERS.md
          echo "" >> SIGNERS.md
          for file in signatures/users/*.json; do
            user=$(basename "$file" .json)
            echo "- @$user" >> SIGNERS.md
          done
          git add SIGNERS.md
          git commit -m "docs(cla): update SIGNERS.md [skip ci]" || true
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" || true

      - name: Update PR Status Check
        uses: LouisBrunner/checks-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ github.event.pull_request.head.sha }}
          name: "CLA Check"
          conclusion: success
          status: completed
